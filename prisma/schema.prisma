generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String               @id @default(uuid())
  email                   String               @unique
  passwordHash            String               @map("password_hash")
  fullName                String               @map("full_name")
  role                    UserRole
  department              String?
  phone                   String?
  isActive                Boolean              @default(true) @map("is_active")
  createdAt               DateTime             @default(now()) @map("created_at")
  updatedAt               DateTime             @updatedAt @map("updated_at")
  lastLogin               DateTime?            @map("last_login")
  twoFactorEnabled        Boolean              @default(false) @map("two_factor_enabled")
  twoFactorSecret         String?              @map("two_factor_secret")
  notificationPreferences Json                 @default("{\"email\": true, \"system\": true}") @map("notification_preferences")
  isDeleted               Boolean              @default(false) @map("is_deleted")
  auditLogs               AuditLog[]
  budgetApprovals         BudgetApproval[]
  approvedTransactions    BudgetTransaction[]  @relation("TransactionApprovedBy")
  createdTransactions     BudgetTransaction[]  @relation("TransactionCreatedBy")
  approvedBudgets         Budget[]             @relation("BudgetApprovedBy")
  createdBudgets          Budget[]             @relation("BudgetCreatedBy")
  reviewedExtractions     DocumentExtraction[] @relation("ExtractionReviewedBy")
  uploadedDocuments       Document[]           @relation("DocumentUploadedBy")
  approvedExpenses        Expense[]            @relation("ExpenseApprovedBy")
  createdExpenses         Expense[]            @relation("ExpenseCreatedBy")
  createdInvoices              Invoice[]
  sessions                     Session[]
  createdTenders               Tender[]
  tenderAnalyses               TenderAnalysis[]         @relation("TenderAnalysisCreator")
  expenseCategorizationReviews ExpenseCategorization[]  @relation("ExpenseCategorizationReviewer")

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Company {
  id                 String      @id @default(uuid())
  name               String
  type               CompanyType
  country            String?
  website            String?
  primaryContact     String?     @map("primary_contact")
  email              String?
  phone              String?
  address            String?
  paymentTerms       String?     @map("payment_terms")
  creditLimit        Decimal?    @map("credit_limit") @db.Decimal(12, 2)
  currency           String      @default("USD")
  taxId              String?     @map("tax_id")
  registrationNumber String?     @map("registration_number")
  certifications     Json?
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")
  isActive           Boolean     @default(true) @map("is_active")
  isDeleted          Boolean     @default(false) @map("is_deleted")
  notes              String?
  expenses           Expense[]
  products           Product[]

  @@map("companies")
}

model Product {
  id             String        @id @default(uuid())
  sku            String        @unique
  name           String
  description    String?
  category       String?
  subCategory    String?       @map("sub_category")
  manufacturerId String?       @map("manufacturer_id")
  unitOfMeasure  String?       @map("unit_of_measure")
  costPrice      Decimal?      @map("cost_price") @db.Decimal(12, 2)
  sellingPrice   Decimal?      @map("selling_price") @db.Decimal(12, 2)
  currency       String        @default("USD")
  minStockLevel  Int           @default(0) @map("min_stock_level")
  maxStockLevel  Int?          @map("max_stock_level")
  reorderPoint   Int?          @map("reorder_point")
  leadTimeDays   Int?          @map("lead_time_days")
  specifications Json?
  certifications Json?
  images         Json?
  isActive       Boolean       @default(true) @map("is_active")
  isDeleted      Boolean       @default(false) @map("is_deleted")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  inventory      Inventory[]
  invoiceItems   InvoiceItem[]
  manufacturer   Company?      @relation(fields: [manufacturerId], references: [id])
  optimizations  InventoryOptimization[]

  @@map("products")
}

model Inventory {
  id                String          @id @default(uuid())
  productId         String          @map("product_id")
  batchNumber       String?         @map("batch_number")
  serialNumber      String?         @map("serial_number")
  quantity          Int
  availableQuantity Int             @map("available_quantity")
  reservedQuantity  Int             @default(0) @map("reserved_quantity")
  location          String?
  expiryDate        DateTime?       @map("expiry_date")
  receivedDate      DateTime?       @map("received_date")
  purchaseOrderId   String?         @map("purchase_order_id")
  unitCost          Decimal?        @map("unit_cost") @db.Decimal(12, 2)
  totalValue        Decimal?        @map("total_value") @db.Decimal(12, 2)
  status            InventoryStatus @default(AVAILABLE)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  product           Product         @relation(fields: [productId], references: [id])

  @@map("inventory")
}

model Customer {
  id                 String       @id @default(uuid())
  name               String
  type               CustomerType @default(GOVERNMENT)
  registrationNumber String?      @map("registration_number")
  taxId              String?      @map("tax_id")
  address            String?
  city               String?
  country            String       @default("Kuwait")
  primaryContact     String?      @map("primary_contact")
  email              String?
  phone              String?
  paymentTerms       String?      @map("payment_terms")
  creditLimit        Decimal?     @map("credit_limit") @db.Decimal(12, 2)
  currentBalance     Decimal      @default(0) @map("current_balance") @db.Decimal(12, 2)
  departments        Json?
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  isActive           Boolean      @default(true) @map("is_active")
  isDeleted          Boolean      @default(false) @map("is_deleted")
  invoices           Invoice[]
  tenders            Tender[]

  @@map("customers")
}

model Tender {
  id                     String       @id @default(uuid())
  tenderNumber           String       @unique @map("tender_number")
  title                  String
  description            String?
  customerId             String?      @map("customer_id")
  department             String?
  category               String?
  submissionDeadline     DateTime?    @map("submission_deadline")
  openingDate            DateTime?    @map("opening_date")
  estimatedValue         Decimal?     @map("estimated_value") @db.Decimal(12, 2)
  currency               String       @default("KWD")
  status                 TenderStatus @default(DRAFT)
  documents              Json?
  products               Json?
  technicalRequirements  String?      @map("technical_requirements")
  commercialRequirements String?      @map("commercial_requirements")
  bondRequired           Boolean      @default(false) @map("bond_required")
  bondAmount             Decimal?     @map("bond_amount") @db.Decimal(12, 2)
  createdById            String?      @map("created_by")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")
  notes                  String?
  isDeleted              Boolean      @default(false) @map("is_deleted")
  createdBy              User?        @relation(fields: [createdById], references: [id])
  customer               Customer?    @relation(fields: [customerId], references: [id])
  analysis               TenderAnalysis?

  @@index([status])
  @@index([submissionDeadline])
  @@map("tenders")
}

model Budget {
  id           String           @id @default(uuid())
  name         String
  fiscalYear   Int              @map("fiscal_year")
  type         BudgetType
  department   String?
  status       BudgetStatus     @default(DRAFT)
  currency     String           @default("KWD")
  totalAmount  Decimal          @map("total_amount") @db.Decimal(15, 2)
  startDate    DateTime         @map("start_date")
  endDate      DateTime         @map("end_date")
  createdById  String?          @map("created_by")
  approvedById String?          @map("approved_by")
  approvedDate DateTime?        @map("approved_date")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  isDeleted    Boolean          @default(false) @map("is_deleted")
  notes        String?
  alerts       BudgetAlert[]
  categories   BudgetCategory[]
  approvedBy   User?            @relation("BudgetApprovedBy", fields: [approvedById], references: [id])
  createdBy    User?            @relation("BudgetCreatedBy", fields: [createdById], references: [id])

  @@index([status])
  @@index([fiscalYear])
  @@map("budgets")
}

model BudgetCategory {
  id                   String              @id @default(uuid())
  budgetId             String              @map("budget_id")
  parentCategoryId     String?             @map("parent_category_id")
  name                 String
  code                 String?             @unique
  type                 CategoryType
  allocatedAmount      Decimal             @map("allocated_amount") @db.Decimal(15, 2)
  spentAmount          Decimal             @default(0) @map("spent_amount") @db.Decimal(15, 2)
  committedAmount      Decimal             @default(0) @map("committed_amount") @db.Decimal(15, 2)
  varianceThreshold    Decimal             @default(10) @map("variance_threshold_percent") @db.Decimal(5, 2)
  requiresApprovalOver Decimal?            @map("requires_approval_over") @db.Decimal(15, 2)
  notes                String?
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  isDeleted            Boolean             @default(false) @map("is_deleted")
  budget               Budget              @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  parentCategory       BudgetCategory?     @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories      BudgetCategory[]    @relation("CategoryHierarchy")
  transactions         BudgetTransaction[]
  expenses             Expense[]

  @@index([budgetId])
  @@map("budget_categories")
}

model BudgetTransaction {
  id               String            @id @default(uuid())
  budgetCategoryId String            @map("budget_category_id")
  transactionDate  DateTime          @map("transaction_date")
  description      String
  amount           Decimal           @db.Decimal(15, 2)
  transactionType  TransactionType   @map("transaction_type")
  referenceType    ReferenceType?    @map("reference_type")
  referenceId      String?           @map("reference_id")
  status           TransactionStatus @default(PENDING)
  createdById      String?           @map("created_by")
  approvedById     String?           @map("approved_by")
  approvedDate     DateTime?         @map("approved_date")
  attachmentUrl    String?           @map("attachment_url")
  notes            String?
  createdAt        DateTime          @default(now()) @map("created_at")
  approvals        BudgetApproval[]
  approvedBy       User?             @relation("TransactionApprovedBy", fields: [approvedById], references: [id])
  budgetCategory   BudgetCategory    @relation(fields: [budgetCategoryId], references: [id])
  createdBy        User?             @relation("TransactionCreatedBy", fields: [createdById], references: [id])

  @@index([transactionDate])
  @@index([status])
  @@map("budget_transactions")
}

model BudgetApproval {
  id                  String            @id @default(uuid())
  budgetTransactionId String            @map("budget_transaction_id")
  approverId          String            @map("approver_id")
  approvalLevel       Int               @map("approval_level")
  status              ApprovalStatus    @default(PENDING)
  comments            String?
  approvedAt          DateTime?         @map("approved_at")
  createdAt           DateTime          @default(now()) @map("created_at")
  approver            User              @relation(fields: [approverId], references: [id])
  budgetTransaction   BudgetTransaction @relation(fields: [budgetTransactionId], references: [id], onDelete: Cascade)

  @@map("budget_approvals")
}

model BudgetAlert {
  id               String        @id @default(uuid())
  budgetId         String        @map("budget_id")
  categoryId       String?       @map("category_id")
  alertType        AlertType     @map("alert_type")
  severity         AlertSeverity
  message          String
  threshold        Decimal?      @db.Decimal(5, 2)
  currentValue     Decimal?      @map("current_value") @db.Decimal(15, 2)
  isAcknowledged   Boolean       @default(false) @map("is_acknowledged")
  acknowledgedById String?       @map("acknowledged_by")
  acknowledgedAt   DateTime?     @map("acknowledged_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  budget           Budget        @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@map("budget_alerts")
}

model Expense {
  id               String          @id @default(uuid())
  expenseNumber    String          @unique @map("expense_number")
  category         String
  subCategory      String?         @map("sub_category")
  description      String
  amount           Decimal         @db.Decimal(12, 2)
  currency         String          @default("KWD")
  expenseDate      DateTime        @map("expense_date")
  paymentMethod    String?         @map("payment_method")
  vendorId         String?         @map("vendor_id")
  budgetCategoryId String?         @map("budget_category_id")
  receiptUrl       String?         @map("receipt_url")
  status           ExpenseStatus   @default(PENDING)
  createdById      String?         @map("created_by")
  approvedById     String?         @map("approved_by")
  approvedDate     DateTime?       @map("approved_date")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  notes            String?
  isDeleted        Boolean         @default(false) @map("is_deleted")
  approvedBy       User?           @relation("ExpenseApprovedBy", fields: [approvedById], references: [id])
  budgetCategory   BudgetCategory? @relation(fields: [budgetCategoryId], references: [id])
  createdBy        User?           @relation("ExpenseCreatedBy", fields: [createdById], references: [id])
  vendor           Company?        @relation(fields: [vendorId], references: [id])
  categorization   ExpenseCategorization?

  @@index([status])
  @@map("expenses")
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique @map("invoice_number")
  customerId    String        @map("customer_id")
  invoiceDate   DateTime      @map("invoice_date")
  dueDate       DateTime      @map("due_date")
  subtotal      Decimal       @db.Decimal(12, 2)
  taxAmount     Decimal       @default(0) @map("tax_amount") @db.Decimal(12, 2)
  totalAmount   Decimal       @map("total_amount") @db.Decimal(12, 2)
  paidAmount    Decimal       @default(0) @map("paid_amount") @db.Decimal(12, 2)
  currency      String        @default("KWD")
  status        InvoiceStatus @default(DRAFT)
  paymentTerms  String?       @map("payment_terms")
  notes         String?
  createdById   String?       @map("created_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  isDeleted     Boolean       @default(false) @map("is_deleted")
  items         InvoiceItem[]
  createdBy     User?         @relation(fields: [createdById], references: [id])
  customer      Customer      @relation(fields: [customerId], references: [id])

  @@index([status])
  @@index([customerId])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String   @map("invoice_id")
  productId   String?  @map("product_id")
  description String
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(12, 2)
  totalPrice  Decimal  @map("total_price") @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Document {
  id           String               @id @default(uuid())
  name         String
  originalName String               @map("original_name")
  mimeType     String               @map("mime_type")
  size         Int
  path         String
  url          String?
  type         DocumentType
  status       DocumentStatus       @default(PENDING)
  moduleType   ModuleType           @map("module_type")
  moduleId     String?              @map("module_id")
  tags         String[]             @default([])
  description  String?
  uploadedById String?              @map("uploaded_by")
  processedAt  DateTime?            @map("processed_at")
  expiryDate   DateTime?            @map("expiry_date")
  isArchived   Boolean              @default(false) @map("is_archived")
  isDeleted    Boolean              @default(false) @map("is_deleted")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  metadata     Json?
  extractions  DocumentExtraction[]
  versions     DocumentVersion[]
  uploadedBy   User?                @relation("DocumentUploadedBy", fields: [uploadedById], references: [id])

  @@index([type])
  @@index([moduleType, moduleId])
  @@index([status])
  @@index([uploadedById])
  @@map("documents")
}

model DocumentVersion {
  id           String   @id @default(uuid())
  documentId   String   @map("document_id")
  version      Int
  name         String
  path         String
  size         Int
  uploadedById String?  @map("uploaded_by")
  changes      String?
  createdAt    DateTime @default(now()) @map("created_at")
  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@map("document_versions")
}

model DocumentExtraction {
  id             String           @id @default(uuid())
  documentId     String           @map("document_id")
  extractionType ExtractionType   @map("extraction_type")
  provider       String
  model          String
  rawResponse    Json?            @map("raw_response")
  extractedData  Json             @map("extracted_data")
  confidence     Decimal?         @db.Decimal(5, 2)
  status         ExtractionStatus @default(PENDING)
  errorMessage   String?          @map("error_message")
  processingTime Int?             @map("processing_time_ms")
  reviewedById   String?          @map("reviewed_by")
  reviewedAt     DateTime?        @map("reviewed_at")
  isApproved     Boolean          @default(false) @map("is_approved")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  document       Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  reviewedBy     User?            @relation("ExtractionReviewedBy", fields: [reviewedById], references: [id])

  @@index([documentId])
  @@index([status])
  @@map("document_extractions")
}

model AIUsageLog {
  id               String   @id @default(uuid())
  provider         String
  model            String
  endpoint         String
  promptTokens     Int      @map("prompt_tokens")
  completionTokens Int      @map("completion_tokens")
  totalTokens      Int      @map("total_tokens")
  latencyMs        Int      @map("latency_ms")
  success          Boolean
  errorMessage     String?  @map("error_message")
  taskType         String?  @map("task_type")
  userId           String?  @map("user_id")
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([provider])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model Supplier {
  id                 String   @id @default(uuid())
  name               String
  code               String?  @unique
  category           String?
  contactPerson      String?  @map("contact_person")
  email              String?
  phone              String?
  address            String?
  city               String?
  country            String   @default("Kuwait")
  website            String?
  taxId              String?  @map("tax_id")
  registrationNumber String?  @map("registration_number")
  paymentTerms       String?  @map("payment_terms")
  leadTime           Int?     @map("lead_time")
  rating             Decimal? @db.Decimal(3, 2)
  notes              String?
  isActive           Boolean  @default(true) @map("is_active")
  isDeleted          Boolean  @default(false) @map("is_deleted")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("suppliers")
}

enum UserRole {
  ADMIN
  CEO
  CFO
  FINANCE_MANAGER
  MANAGER
  SALES
  WAREHOUSE
  FINANCE
}

enum CompanyType {
  MANUFACTURER
  SUPPLIER
  CUSTOMER
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  EXPIRED
  DAMAGED
}

enum CustomerType {
  GOVERNMENT
  PRIVATE
  CLINIC
}

enum TenderStatus {
  DRAFT
  IN_PROGRESS
  SUBMITTED
  WON
  LOST
  CANCELLED
}

enum BudgetType {
  MASTER
  DEPARTMENT
  PROJECT
  TENDER
}

enum BudgetStatus {
  DRAFT
  PENDING
  APPROVED
  ACTIVE
  CLOSED
  REJECTED
}

enum CategoryType {
  REVENUE
  EXPENSE
  CAPITAL
}

enum TransactionType {
  EXPENSE
  REVENUE
  TRANSFER
  ADJUSTMENT
}

enum ReferenceType {
  INVOICE
  EXPENSE
  TENDER
  PURCHASE_ORDER
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  POSTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AlertType {
  THRESHOLD_80
  THRESHOLD_90
  EXCEEDED
  VARIANCE
  APPROVAL_PENDING
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum DocumentType {
  TENDER_DOCUMENT
  TENDER_SPECS
  TENDER_BOQ
  TENDER_COMMERCIAL
  INVOICE
  RECEIPT
  EXPENSE_RECEIPT
  DELIVERY_NOTE
  PURCHASE_ORDER
  CONTRACT
  CERTIFICATE
  LICENSE
  WARRANTY
  PRODUCT_DATASHEET
  QUOTATION
  PROPOSAL
  OTHER
}

enum DocumentStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
  ARCHIVED
}

enum ModuleType {
  TENDER
  BUDGET
  EXPENSE
  INVOICE
  DELIVERY
  INVENTORY
  CUSTOMER
  PRODUCT
  GENERAL
}

enum ExtractionType {
  TENDER_EXTRACTION
  INVOICE_EXTRACTION
  EXPENSE_EXTRACTION
  DELIVERY_EXTRACTION
  PRODUCT_EXTRACTION
  OCR_TEXT
  SUMMARIZATION
  TRANSLATION
}

enum ExtractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  NEEDS_REVIEW
}

enum SupplierCategory {
  MEDICAL_EQUIPMENT
  PHARMACEUTICALS
  LABORATORY
  IMAGING
  SURGICAL_INSTRUMENTS
  CONSUMABLES
  IT_EQUIPMENT
  FURNITURE
  OTHER
}

// ==================== TENDER ANALYSIS AI ====================

model TenderAnalysis {
  id                 String           @id @default(uuid())
  tenderId           String           @unique @map("tender_id")
  
  // SWOT Analysis
  strengths          String           @db.Text // JSON array
  weaknesses         String           @db.Text // JSON array
  opportunities      String           @db.Text // JSON array
  threats            String           @db.Text // JSON array
  
  // Win Probability
  winProbability     Decimal          @db.Decimal(5, 2) @map("win_probability") // 0-100
  confidenceLevel    String           @map("confidence_level") // HIGH, MEDIUM, LOW
  
  // Competitive Scoring
  competitiveScore   Decimal          @db.Decimal(5, 2) @map("competitive_score") // 0-100
  pricingScore       Decimal          @db.Decimal(5, 2) @map("pricing_score")
  technicalScore     Decimal          @db.Decimal(5, 2) @map("technical_score")
  experienceScore    Decimal          @db.Decimal(5, 2) @map("experience_score")
  
  // Key Factors
  keyFactors         String           @db.Text // JSON array
  recommendations    String           @db.Text // JSON array
  riskFactors        String           @db.Text // JSON array
  
  // AI Provider Info
  aiProvider         String           @map("ai_provider")
  aiModel            String           @map("ai_model")
  processingTimeMs   Int              @map("processing_time_ms")
  
  // Metadata
  analyzedAt         DateTime         @default(now()) @map("analyzed_at")
  analyzedById       String           @map("analyzed_by_id")
  
  // Relations
  tender             Tender           @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  analyzedBy         User             @relation("TenderAnalysisCreator", fields: [analyzedById], references: [id])
  
  @@index([tenderId])
  @@index([winProbability])
  @@map("tender_analyses")
}

// ==================== EXPENSE CATEGORIZATION AI ====================

model ExpenseCategorization {
  id                 String           @id @default(uuid())
  expenseId          String           @unique @map("expense_id")
  
  // AI Categorization
  predictedCategory  String           @map("predicted_category")
  confidence         Decimal          @db.Decimal(5, 2) // 0-100
  alternativeCategories String        @db.Text @map("alternative_categories") // JSON array with scores
  
  // Anomaly Detection
  isAnomaly          Boolean          @default(false) @map("is_anomaly")
  anomalyScore       Decimal?         @db.Decimal(5, 2) @map("anomaly_score") // 0-100
  anomalyReasons     String?          @db.Text @map("anomaly_reasons") // JSON array
  
  // Pattern Analysis
  similarExpenses    String?          @db.Text @map("similar_expenses") // JSON array of IDs
  spendingPattern    String?          @map("spending_pattern") // REGULAR, SEASONAL, IRREGULAR
  
  // AI Provider Info
  aiProvider         String           @map("ai_provider")
  aiModel            String           @map("ai_model")
  
  // Metadata
  categorizedAt      DateTime         @default(now()) @map("categorized_at")
  reviewedAt         DateTime?        @map("reviewed_at")
  reviewedById       String?          @map("reviewed_by_id")
  isConfirmed        Boolean          @default(false) @map("is_confirmed")
  
  // Relations
  expense            Expense          @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  reviewedBy         User?            @relation("ExpenseCategorizationReviewer", fields: [reviewedById], references: [id])
  
  @@index([expenseId])
  @@index([isAnomaly])
  @@index([confidence])
  @@map("expense_categorizations")
}

// ==================== INVENTORY OPTIMIZATION AI ====================

model InventoryOptimization {
  id                    String        @id @default(uuid())
  productId             String        @map("product_id")
  
  // Demand Forecasting
  predictedDemand       Int           @map("predicted_demand")
  demandTrend           String        @map("demand_trend") // INCREASING, DECREASING, STABLE, SEASONAL
  seasonalityFactor     Decimal?      @db.Decimal(5, 2) @map("seasonality_factor")
  
  // Inventory Recommendations
  recommendedReorderPoint Int         @map("recommended_reorder_point")
  recommendedOrderQty   Int           @map("recommended_order_qty")
  recommendedSafetyStock Int          @map("recommended_safety_stock")
  
  // Cost Analysis
  estimatedStockoutRisk Decimal       @db.Decimal(5, 2) @map("estimated_stockout_risk") // 0-100
  estimatedCarryingCost Decimal       @db.Decimal(12, 2) @map("estimated_carrying_cost")
  potentialCostSavings  Decimal       @db.Decimal(12, 2) @map("potential_cost_savings")
  
  // Analysis Details
  dataPoints            Int           @map("data_points") // number of historical records analyzed
  confidenceScore       Decimal       @db.Decimal(5, 2) @map("confidence_score")
  insights              String        @db.Text // JSON array
  
  // AI Provider Info
  aiProvider            String        @map("ai_provider")
  aiModel               String        @map("ai_model")
  
  // Metadata
  analyzedAt            DateTime      @default(now()) @map("analyzed_at")
  validUntil            DateTime      @map("valid_until")
  
  // Relations
  product               Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
  @@index([analyzedAt])
  @@index([demandTrend])
  @@map("inventory_optimizations")
}

// ==================== APP SETTINGS ====================

model AppSettings {
  id          String    @id @default(uuid())
  key         String    @unique
  value       String    @db.Text
  isEncrypted Boolean   @default(true) @map("is_encrypted")
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("app_settings")
}
