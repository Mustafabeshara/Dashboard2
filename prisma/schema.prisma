// Medical Distribution Management System - Prisma Schema
// For Beshara Group - Healthcare Solutions Division

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MANAGEMENT ====================

model User {
  id                      String    @id @default(uuid())
  email                   String    @unique
  passwordHash            String    @map("password_hash")
  fullName                String    @map("full_name")
  role                    UserRole
  department              String?
  phone                   String?
  isActive                Boolean   @default(true) @map("is_active")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  lastLogin               DateTime? @map("last_login")
  twoFactorEnabled        Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret         String?   @map("two_factor_secret")
  notificationPreferences Json      @default("{\"email\": true, \"system\": true}") @map("notification_preferences")
  isDeleted               Boolean   @default(false) @map("is_deleted")

  // Relations
  createdBudgets          Budget[]             @relation("BudgetCreatedBy")
  approvedBudgets         Budget[]             @relation("BudgetApprovedBy")
  createdTransactions     BudgetTransaction[]  @relation("TransactionCreatedBy")
  approvedTransactions    BudgetTransaction[]  @relation("TransactionApprovedBy")
  budgetApprovals         BudgetApproval[]
  createdExpenses         Expense[]            @relation("ExpenseCreatedBy")
  approvedExpenses        Expense[]            @relation("ExpenseApprovedBy")
  createdInvoices         Invoice[]
  createdTenders          Tender[]
  auditLogs               AuditLog[]
  sessions                Session[]
  uploadedDocuments       Document[]           @relation("DocumentUploadedBy")
  reviewedExtractions     DocumentExtraction[] @relation("ExtractionReviewedBy")

  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

enum UserRole {
  ADMIN
  CEO
  CFO
  FINANCE_MANAGER
  MANAGER
  SALES
  WAREHOUSE
  FINANCE
}

// ==================== COMPANY MANAGEMENT ====================

model Company {
  id                 String      @id @default(uuid())
  name               String
  type               CompanyType
  country            String?
  website            String?
  primaryContact     String?     @map("primary_contact")
  email              String?
  phone              String?
  address            String?
  paymentTerms       String?     @map("payment_terms")
  creditLimit        Decimal?    @db.Decimal(12, 2) @map("credit_limit")
  currency           String      @default("USD")
  taxId              String?     @map("tax_id")
  registrationNumber String?     @map("registration_number")
  certifications     Json?
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")
  isActive           Boolean     @default(true) @map("is_active")
  isDeleted          Boolean     @default(false) @map("is_deleted")
  notes              String?

  // Relations
  products           Product[]
  expenses           Expense[]

  @@map("companies")
}

enum CompanyType {
  MANUFACTURER
  SUPPLIER
  CUSTOMER
}

// ==================== PRODUCT & INVENTORY ====================

model Product {
  id              String    @id @default(uuid())
  sku             String    @unique
  name            String
  description     String?
  category        String?
  subCategory     String?   @map("sub_category")
  manufacturerId  String?   @map("manufacturer_id")
  unitOfMeasure   String?   @map("unit_of_measure")
  costPrice       Decimal?  @db.Decimal(12, 2) @map("cost_price")
  sellingPrice    Decimal?  @db.Decimal(12, 2) @map("selling_price")
  currency        String    @default("USD")
  minStockLevel   Int       @default(0) @map("min_stock_level")
  maxStockLevel   Int?      @map("max_stock_level")
  reorderPoint    Int?      @map("reorder_point")
  leadTimeDays    Int?      @map("lead_time_days")
  specifications  Json?
  certifications  Json?
  images          Json?
  isActive        Boolean   @default(true) @map("is_active")
  isDeleted       Boolean   @default(false) @map("is_deleted")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  manufacturer    Company?  @relation(fields: [manufacturerId], references: [id])
  inventory       Inventory[]
  invoiceItems    InvoiceItem[]

  @@map("products")
}

model Inventory {
  id                String          @id @default(uuid())
  productId         String          @map("product_id")
  batchNumber       String?         @map("batch_number")
  serialNumber      String?         @map("serial_number")
  quantity          Int
  availableQuantity Int             @map("available_quantity")
  reservedQuantity  Int             @default(0) @map("reserved_quantity")
  location          String?
  expiryDate        DateTime?       @map("expiry_date")
  receivedDate      DateTime?       @map("received_date")
  purchaseOrderId   String?         @map("purchase_order_id")
  unitCost          Decimal?        @db.Decimal(12, 2) @map("unit_cost")
  totalValue        Decimal?        @db.Decimal(12, 2) @map("total_value")
  status            InventoryStatus @default(AVAILABLE)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  product           Product         @relation(fields: [productId], references: [id])

  @@map("inventory")
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  EXPIRED
  DAMAGED
}

// ==================== CUSTOMER MANAGEMENT ====================

model Customer {
  id                 String       @id @default(uuid())
  name               String
  type               CustomerType @default(GOVERNMENT)
  registrationNumber String?      @map("registration_number")
  taxId              String?      @map("tax_id")
  address            String?
  city               String?
  country            String       @default("Kuwait")
  primaryContact     String?      @map("primary_contact")
  email              String?
  phone              String?
  paymentTerms       String?      @map("payment_terms")
  creditLimit        Decimal?     @db.Decimal(12, 2) @map("credit_limit")
  currentBalance     Decimal      @default(0) @db.Decimal(12, 2) @map("current_balance")
  departments        Json?
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  isActive           Boolean      @default(true) @map("is_active")
  isDeleted          Boolean      @default(false) @map("is_deleted")

  // Relations
  tenders            Tender[]
  invoices           Invoice[]

  @@map("customers")
}

enum CustomerType {
  GOVERNMENT
  PRIVATE
  CLINIC
}

// ==================== TENDER MANAGEMENT ====================

model Tender {
  id                     String       @id @default(uuid())
  tenderNumber           String       @unique @map("tender_number")
  title                  String
  description            String?
  customerId             String?      @map("customer_id")
  department             String?
  category               String?
  submissionDeadline     DateTime?    @map("submission_deadline")
  openingDate            DateTime?    @map("opening_date")
  estimatedValue         Decimal?     @db.Decimal(12, 2) @map("estimated_value")
  currency               String       @default("KWD")
  status                 TenderStatus @default(DRAFT)
  documents              Json?
  products               Json?
  technicalRequirements  String?      @map("technical_requirements")
  commercialRequirements String?      @map("commercial_requirements")
  bondRequired           Boolean      @default(false) @map("bond_required")
  bondAmount             Decimal?     @db.Decimal(12, 2) @map("bond_amount")
  createdById            String?      @map("created_by")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")
  notes                  String?
  isDeleted              Boolean      @default(false) @map("is_deleted")

  // Relations
  customer               Customer?    @relation(fields: [customerId], references: [id])
  createdBy              User?        @relation(fields: [createdById], references: [id])

  @@index([status])
  @@index([submissionDeadline])
  @@map("tenders")
}

enum TenderStatus {
  DRAFT
  IN_PROGRESS
  SUBMITTED
  WON
  LOST
  CANCELLED
}

// ==================== BUDGET MANAGEMENT ====================

model Budget {
  id           String       @id @default(uuid())
  name         String
  fiscalYear   Int          @map("fiscal_year")
  type         BudgetType
  department   String?
  status       BudgetStatus @default(DRAFT)
  currency     String       @default("KWD")
  totalAmount  Decimal      @db.Decimal(15, 2) @map("total_amount")
  startDate    DateTime     @map("start_date")
  endDate      DateTime     @map("end_date")
  createdById  String?      @map("created_by")
  approvedById String?      @map("approved_by")
  approvedDate DateTime?    @map("approved_date")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  isDeleted    Boolean      @default(false) @map("is_deleted")
  notes        String?

  // Relations
  createdBy    User?            @relation("BudgetCreatedBy", fields: [createdById], references: [id])
  approvedBy   User?            @relation("BudgetApprovedBy", fields: [approvedById], references: [id])
  categories   BudgetCategory[]
  alerts       BudgetAlert[]

  @@index([status])
  @@index([fiscalYear])
  @@map("budgets")
}

enum BudgetType {
  MASTER
  DEPARTMENT
  PROJECT
  TENDER
}

enum BudgetStatus {
  DRAFT
  PENDING
  APPROVED
  ACTIVE
  CLOSED
  REJECTED
}

model BudgetCategory {
  id                     String              @id @default(uuid())
  budgetId               String              @map("budget_id")
  parentCategoryId       String?             @map("parent_category_id")
  name                   String
  code                   String?             @unique
  type                   CategoryType
  allocatedAmount        Decimal             @db.Decimal(15, 2) @map("allocated_amount")
  spentAmount            Decimal             @default(0) @db.Decimal(15, 2) @map("spent_amount")
  committedAmount        Decimal             @default(0) @db.Decimal(15, 2) @map("committed_amount")
  varianceThreshold      Decimal             @default(10) @db.Decimal(5, 2) @map("variance_threshold_percent")
  requiresApprovalOver   Decimal?            @db.Decimal(15, 2) @map("requires_approval_over")
  notes                  String?
  createdAt              DateTime            @default(now()) @map("created_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")
  isDeleted              Boolean             @default(false) @map("is_deleted")

  // Relations
  budget                 Budget              @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  parentCategory         BudgetCategory?     @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories        BudgetCategory[]    @relation("CategoryHierarchy")
  transactions           BudgetTransaction[]
  expenses               Expense[]

  @@index([budgetId])
  @@map("budget_categories")
}

enum CategoryType {
  REVENUE
  EXPENSE
  CAPITAL
}

model BudgetTransaction {
  id               String            @id @default(uuid())
  budgetCategoryId String            @map("budget_category_id")
  transactionDate  DateTime          @map("transaction_date")
  description      String
  amount           Decimal           @db.Decimal(15, 2)
  transactionType  TransactionType   @map("transaction_type")
  referenceType    ReferenceType?    @map("reference_type")
  referenceId      String?           @map("reference_id")
  status           TransactionStatus @default(PENDING)
  createdById      String?           @map("created_by")
  approvedById     String?           @map("approved_by")
  approvedDate     DateTime?         @map("approved_date")
  attachmentUrl    String?           @map("attachment_url")
  notes            String?
  createdAt        DateTime          @default(now()) @map("created_at")

  // Relations
  budgetCategory   BudgetCategory    @relation(fields: [budgetCategoryId], references: [id])
  createdBy        User?             @relation("TransactionCreatedBy", fields: [createdById], references: [id])
  approvedBy       User?             @relation("TransactionApprovedBy", fields: [approvedById], references: [id])
  approvals        BudgetApproval[]

  @@index([transactionDate])
  @@index([status])
  @@map("budget_transactions")
}

enum TransactionType {
  EXPENSE
  REVENUE
  TRANSFER
  ADJUSTMENT
}

enum ReferenceType {
  INVOICE
  EXPENSE
  TENDER
  PURCHASE_ORDER
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  POSTED
}

model BudgetApproval {
  id                  String          @id @default(uuid())
  budgetTransactionId String          @map("budget_transaction_id")
  approverId          String          @map("approver_id")
  approvalLevel       Int             @map("approval_level")
  status              ApprovalStatus  @default(PENDING)
  comments            String?
  approvedAt          DateTime?       @map("approved_at")
  createdAt           DateTime        @default(now()) @map("created_at")

  // Relations
  budgetTransaction   BudgetTransaction @relation(fields: [budgetTransactionId], references: [id], onDelete: Cascade)
  approver            User              @relation(fields: [approverId], references: [id])

  @@map("budget_approvals")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model BudgetAlert {
  id               String          @id @default(uuid())
  budgetId         String          @map("budget_id")
  categoryId       String?         @map("category_id")
  alertType        AlertType       @map("alert_type")
  severity         AlertSeverity
  message          String
  threshold        Decimal?        @db.Decimal(5, 2)
  currentValue     Decimal?        @db.Decimal(15, 2) @map("current_value")
  isAcknowledged   Boolean         @default(false) @map("is_acknowledged")
  acknowledgedById String?         @map("acknowledged_by")
  acknowledgedAt   DateTime?       @map("acknowledged_at")
  createdAt        DateTime        @default(now()) @map("created_at")

  // Relations
  budget           Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@map("budget_alerts")
}

enum AlertType {
  THRESHOLD_80
  THRESHOLD_90
  EXCEEDED
  VARIANCE
  APPROVAL_PENDING
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ==================== EXPENSE MANAGEMENT ====================

model Expense {
  id               String        @id @default(uuid())
  expenseNumber    String        @unique @map("expense_number")
  category         String
  subCategory      String?       @map("sub_category")
  description      String
  amount           Decimal       @db.Decimal(12, 2)
  currency         String        @default("KWD")
  expenseDate      DateTime      @map("expense_date")
  paymentMethod    String?       @map("payment_method")
  vendorId         String?       @map("vendor_id")
  budgetCategoryId String?       @map("budget_category_id")
  receiptUrl       String?       @map("receipt_url")
  status           ExpenseStatus @default(PENDING)
  createdById      String?       @map("created_by")
  approvedById     String?       @map("approved_by")
  approvedDate     DateTime?     @map("approved_date")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  notes            String?
  isDeleted        Boolean       @default(false) @map("is_deleted")

  // Relations
  vendor           Company?        @relation(fields: [vendorId], references: [id])
  budgetCategory   BudgetCategory? @relation(fields: [budgetCategoryId], references: [id])
  createdBy        User?           @relation("ExpenseCreatedBy", fields: [createdById], references: [id])
  approvedBy       User?           @relation("ExpenseApprovedBy", fields: [approvedById], references: [id])

  @@index([status])
  @@map("expenses")
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

// ==================== INVOICE MANAGEMENT ====================

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique @map("invoice_number")
  customerId    String        @map("customer_id")
  invoiceDate   DateTime      @map("invoice_date")
  dueDate       DateTime      @map("due_date")
  subtotal      Decimal       @db.Decimal(12, 2)
  taxAmount     Decimal       @default(0) @db.Decimal(12, 2) @map("tax_amount")
  totalAmount   Decimal       @db.Decimal(12, 2) @map("total_amount")
  paidAmount    Decimal       @default(0) @db.Decimal(12, 2) @map("paid_amount")
  currency      String        @default("KWD")
  status        InvoiceStatus @default(DRAFT)
  paymentTerms  String?       @map("payment_terms")
  notes         String?
  createdById   String?       @map("created_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  isDeleted     Boolean       @default(false) @map("is_deleted")

  // Relations
  customer      Customer      @relation(fields: [customerId], references: [id])
  createdBy     User?         @relation(fields: [createdById], references: [id])
  items         InvoiceItem[]

  @@index([status])
  @@index([customerId])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String   @map("invoice_id")
  productId   String?  @map("product_id")
  description String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12, 2) @map("unit_price")
  totalPrice  Decimal  @db.Decimal(12, 2) @map("total_price")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ==================== AUDIT LOGGING ====================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  action      String
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id")
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user        User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== DOCUMENT MANAGEMENT ====================

model Document {
  id               String             @id @default(uuid())
  name             String
  originalName     String             @map("original_name")
  mimeType         String             @map("mime_type")
  size             Int                // File size in bytes
  path             String             // Storage path
  url              String?            // Public URL if available
  type             DocumentType
  status           DocumentStatus     @default(PENDING)
  moduleType       ModuleType         @map("module_type")
  moduleId         String?            @map("module_id")
  tags             String[]           @default([])
  description      String?
  uploadedById     String?            @map("uploaded_by")
  processedAt      DateTime?          @map("processed_at")
  expiryDate       DateTime?          @map("expiry_date")
  isArchived       Boolean            @default(false) @map("is_archived")
  isDeleted        Boolean            @default(false) @map("is_deleted")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  metadata         Json?              // Additional metadata

  // Relations
  uploadedBy       User?              @relation("DocumentUploadedBy", fields: [uploadedById], references: [id])
  extractions      DocumentExtraction[]
  versions         DocumentVersion[]

  @@index([type])
  @@index([moduleType, moduleId])
  @@index([status])
  @@index([uploadedById])
  @@map("documents")
}

model DocumentVersion {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  version     Int
  name        String
  path        String
  size        Int
  uploadedById String? @map("uploaded_by")
  changes     String?  // Description of changes
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@map("document_versions")
}

model DocumentExtraction {
  id              String           @id @default(uuid())
  documentId      String           @map("document_id")
  extractionType  ExtractionType   @map("extraction_type")
  provider        String           // AI provider used
  model           String           // AI model used
  rawResponse     Json?            @map("raw_response")
  extractedData   Json             @map("extracted_data")
  confidence      Decimal?         @db.Decimal(5, 2)
  status          ExtractionStatus @default(PENDING)
  errorMessage    String?          @map("error_message")
  processingTime  Int?             @map("processing_time_ms")
  reviewedById    String?          @map("reviewed_by")
  reviewedAt      DateTime?        @map("reviewed_at")
  isApproved      Boolean          @default(false) @map("is_approved")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  document        Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  reviewedBy      User?            @relation("ExtractionReviewedBy", fields: [reviewedById], references: [id])

  @@index([documentId])
  @@index([status])
  @@map("document_extractions")
}

model AIUsageLog {
  id              String   @id @default(uuid())
  provider        String
  model           String
  endpoint        String
  promptTokens    Int      @map("prompt_tokens")
  completionTokens Int     @map("completion_tokens")
  totalTokens     Int      @map("total_tokens")
  latencyMs       Int      @map("latency_ms")
  success         Boolean
  errorMessage    String?  @map("error_message")
  taskType        String?  @map("task_type")
  userId          String?  @map("user_id")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([provider])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

enum DocumentType {
  TENDER_DOCUMENT
  TENDER_SPECS
  TENDER_BOQ
  TENDER_COMMERCIAL
  INVOICE
  RECEIPT
  EXPENSE_RECEIPT
  DELIVERY_NOTE
  PURCHASE_ORDER
  CONTRACT
  CERTIFICATE
  LICENSE
  WARRANTY
  PRODUCT_DATASHEET
  QUOTATION
  PROPOSAL
  OTHER
}

enum DocumentStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
  ARCHIVED
}

enum ModuleType {
  TENDER
  BUDGET
  EXPENSE
  INVOICE
  DELIVERY
  INVENTORY
  CUSTOMER
  PRODUCT
  GENERAL
}

enum ExtractionType {
  TENDER_EXTRACTION
  INVOICE_EXTRACTION
  EXPENSE_EXTRACTION
  DELIVERY_EXTRACTION
  PRODUCT_EXTRACTION
  OCR_TEXT
  SUMMARIZATION
  TRANSLATION
}

enum ExtractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  NEEDS_REVIEW
}

model Supplier {
  id                 String    @id @default(uuid())
  name               String
  code               String?   @unique
  category           String?   // e.g., Medical Equipment, Pharmaceuticals
  contactPerson      String?   @map("contact_person")
  email              String?
  phone              String?
  address            String?
  city               String?
  country            String    @default("Kuwait")
  website            String?
  taxId              String?   @map("tax_id")
  registrationNumber String?   @map("registration_number")
  paymentTerms       String?   @map("payment_terms")
  leadTime           Int?      @map("lead_time") // Days
  rating             Decimal?  @db.Decimal(3, 2) // 0.00 to 5.00
  notes              String?   @db.Text
  isActive           Boolean   @default(true) @map("is_active")
  isDeleted          Boolean   @default(false) @map("is_deleted")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("suppliers")
}

enum SupplierCategory {
  MEDICAL_EQUIPMENT
  PHARMACEUTICALS
  LABORATORY
  IMAGING
  SURGICAL_INSTRUMENTS
  CONSUMABLES
  IT_EQUIPMENT
  FURNITURE
  OTHER
}

// ==================== APP SETTINGS ====================

model AppSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String   @db.Text
  isEncrypted Boolean  @default(false) @map("is_encrypted")
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("app_settings")
}
